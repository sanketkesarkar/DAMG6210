# P5. Presentation

Presentation Link: [Presentation](docs/P5.%20Presentation.pdf)

## Sample DDL Statements

Create a car by inserting into `CarProduction` - it will automatically deduct the stock of the required parts from the `Stock` table, based on `CarBlueprint`

```sql
CREATE or ALTER TRIGGER CarProduction_Stock_Consume
ON CarProduction
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    -- trigger for consuming parts (quantity) from stock when a car is produced

    WITH RankedRows AS ( -- select all candidate batches and rank them based on quantity
    select B.part_id, S.batch_id, S.location_id, S.quantity, CB.part_count, CB.car_id
    , ROW_NUMBER() OVER(PARTITION BY B.part_id ORDER BY quantity DESC) AS RowNumber
    from inserted I
    inner join AssemblyUnit A on A.AssemblyUnitID = I.manufactured_at_id
    inner join [Location] L on L.LocationID = A.location_id
    inner join CarBlueprint CB on CB.car_id = I.car_id
    inner join Batch B on B.part_id = CB.part_id
    inner join Stock S on S.batch_id = B.BatchID and S.location_id = L.LocationID
    )
    update RankedRows
    set quantity = quantity - (part_count * (select count(1) from inserted II where II.car_id = RankedRows.car_id)) -- in case multiple production of the same car is inserted
    where RowNumber = 1

END
```
